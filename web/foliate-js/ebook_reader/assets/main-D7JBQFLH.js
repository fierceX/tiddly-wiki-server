(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();const rt="modulepreload",at=function(n,t){return new URL(n,t).href},M={},y=function(t,e,s){let o=Promise.resolve();if(e&&e.length>0){let d=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};const a=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),c=r?.nonce||r?.getAttribute("nonce");o=d(e.map(l=>{if(l=at(l,s),l in M)return;M[l]=!0;const h=l.endsWith(".css"),f=h?'[rel="stylesheet"]':"";if(s)for(let p=a.length-1;p>=0;p--){const m=a[p];if(m.href===l&&(!h||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${f}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":rt,h||(u.as="script"),u.crossOrigin="",u.href=l,c&&u.setAttribute("nonce",c),document.head.appendChild(u),h)return new Promise((p,m)=>{u.addEventListener("load",p),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return o.then(a=>{for(const r of a||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})},ct=(n,t)=>n.map((e,s,o)=>t(e,s,o)?s:null).filter(e=>e!=null),q=(n,t)=>[-1,...t,n.length].reduce(({xs:e,a:s},o)=>({xs:e?.concat([n.slice(s+1,o)])??[],a:o}),{}).xs,lt=(n,t)=>n.slice(0,-1).concat([n[n.length-1].concat(t[0])]).concat(t.slice(1)),_=/\d/,T=/^epubcfi\((.*)\)$/,z=n=>n.replace(/[\^[\](),;=]/g,"^$&"),K=n=>T.test(n)?n:`epubcfi(${n})`,dt=n=>n.match(T)?.[1]??n,ht=n=>(...t)=>`epubcfi(${n(...t.map(e=>e.match(T)?.[1]??e))})`,G=ht((...n)=>n.join("!")),ut=n=>{const t=[];let e,s,o="";const i=r=>(t.push(r),e=null,o=""),a=r=>(o+=r,s=!1);for(const r of Array.from(n.trim()).concat("")){if(r==="^"&&!s){s=!0;continue}if(e==="!")i(["!"]);else if(e===",")i([","]);else if(e==="/"||e===":")if(_.test(r)){a(r);continue}else i([e,parseInt(o)]);else if(e==="~")if(_.test(r)||r==="."){a(r);continue}else i(["~",parseFloat(o)]);else if(e==="@"){if(r===":"){i(["@",parseFloat(o)]),e="@";continue}if(_.test(r)||r==="."){a(r);continue}else i(["@",parseFloat(o)])}else if(e==="["){r===";"&&!s?(i(["[",o]),e=";"):r===","&&!s?(i(["[",o]),e="["):r==="]"&&!s?i(["[",o]):a(r);continue}else if(e?.startsWith(";")){r==="="&&!s?(e=`;${o}`,o=""):r===";"&&!s?(i([e,o]),e=";"):r==="]"&&!s?i([e,o]):a(r);continue}(r==="/"||r===":"||r==="~"||r==="@"||r==="["||r==="!"||r===",")&&(e=r)}return t},Z=(n,t)=>ct(n,([e])=>e===t),ft=n=>{const t=[];let e;for(const[s,o]of n){if(s==="/")t.push({index:o});else{const i=t[t.length-1];if(s===":")i.offset=o;else if(s==="~")i.temporal=o;else if(s==="@")i.spatial=(i.spatial??[]).concat(o);else if(s===";s")i.side=o;else if(s==="[")if(e==="/"&&o)i.id=o;else{i.text=(i.text??[]).concat(o);continue}}e=s}return t},D=n=>q(n,Z(n,"!")).map(ft),L=n=>{const t=ut(dt(n)),e=Z(t,",");if(!e.length)return D(t);const[s,o,i]=q(t,e).map(D);return{parent:s,start:o,end:i}},pt=({index:n,id:t,offset:e,temporal:s,spatial:o,text:i,side:a})=>{const r=a?`;s=${a}`:"";return`/${n}`+(t?`[${z(t)}${r}]`:"")+(e!=null&&n%2?`:${e}`:"")+(s?`~${s}`:"")+(o?`@${o.join(":")}`:"")+(i||!t&&a?"["+(i?.map(z)?.join(",")??"")+r+"]":"")},J=n=>n.parent?[n.parent,n.start,n.end].map(J).join(","):n.map(t=>t.map(pt).join("")).join("!"),P=n=>K(J(n)),E=(n,t)=>typeof n=="string"?P(E(L(n),t)):n.parent?lt(n.parent,n[t?"end":"start"]):n,X=(n,t)=>{typeof n=="string"&&(n=L(n)),typeof t=="string"&&(t=L(t)),n=E(n),t=E(t,!0);const e=n[n.length-1],s=t[t.length-1],o=[],i=[],a=[];let r=!0;const c=Math.max(e.length,s.length);for(let l=0;l<c;l++){const h=e[l],f=s[l];r&&=h?.index===f?.index&&!h?.offset&&!f?.offset,r?o.push(h):(h&&i.push(h),f&&a.push(f))}const d=n.slice(0,-1).concat([o]);return P({parent:d,start:[i],end:[a]})},S=({nodeType:n})=>n===3||n===4,x=({nodeType:n})=>n===1,Q=(n,t)=>{const e=Array.from(n.childNodes).filter(s=>S(s)||x(s));return t?e.map(s=>{const o=t(s);return o===NodeFilter.FILTER_REJECT?null:o===NodeFilter.FILTER_SKIP?Q(s,t):s}).flat().filter(s=>s):e},R=(n,t)=>{const e=Q(n,t).reduce((s,o)=>{let i=s[s.length-1];return i?S(o)?Array.isArray(i)?i.push(o):S(i)?s[s.length-1]=[i,o]:s.push(o):x(i)?s.push(null,o):s.push(o):s.push(o),s},[]);return x(e[0])&&e.unshift("first"),x(e[e.length-1])&&e.push("last"),e.unshift("before"),e.push("after"),e},F=(n,t,e)=>{const{id:s}=t[t.length-1];if(s){const a=n.ownerDocument.getElementById(s);if(a)return{node:a,offset:0}}for(const{index:a}of t){const r=n?R(n,e)[a]:null;if(r==="first")return{node:n.firstChild??n};if(r==="last")return{node:n.lastChild??n};if(r==="before")return{node:n,before:!0};if(r==="after")return{node:n,after:!0};n=r}const{offset:o}=t[t.length-1];if(!Array.isArray(n))return{node:n,offset:o};let i=0;for(const a of n){const{length:r}=a.nodeValue;if(i+r>=o)return{node:a,offset:o-i};i+=r}},k=(n,t,e)=>{const{parentNode:s,id:o}=n,i=R(s,e),a=i.findIndex(d=>Array.isArray(d)?d.some(l=>l===n):d===n),r=i[a];if(Array.isArray(r)){let d=0;for(const l of r)if(l===n){d+=t;break}else d+=l.nodeValue.length;t=d}const c={id:o,index:a,offset:t};return(s!==n.ownerDocument.documentElement?k(s,null,e).concat(c):[c]).filter(d=>d.index!==-1)},Y=(n,t)=>{const{startContainer:e,startOffset:s,endContainer:o,endOffset:i}=n,a=k(e,s,t);if(n.collapsed)return P([a]);const r=k(o,i,t);return X([a],[r])},tt=(n,t,e)=>{const s=E(t),o=E(t,!0),i=n.documentElement,a=F(i,s[0],e),r=F(i,o[0],e),c=n.createRange();return a.before?c.setStartBefore(a.node):a.after?c.setStartAfter(a.node):c.setStart(a.node,a.offset),r.before?c.setEndBefore(r.node):r.after?c.setEndAfter(r.node):c.setEnd(r.node,r.offset),c},mt=n=>{const t=[],{parentNode:e}=n[0],s=k(e);for(const[o,i]of R(e).entries()){const a=n[t.length];i===a&&t.push(P([s.concat({id:a.id,index:o})]))}return t},gt=(n,t)=>F(n.documentElement,E(t)).node,I={fromIndex:n=>K(`/6/${(n+1)*2}`),toIndex:n=>n?.at(-1).index/2-1},wt=({spine_index:n,start_cfi:t,end_cfi:e})=>{const s=I.fromIndex(n)+"!";return X(s+t.slice(2),s+e.slice(2))},vt=Object.freeze(Object.defineProperty({__proto__:null,collapse:E,fake:I,fromCalibreHighlight:wt,fromElements:mt,fromRange:Y,isCFI:T,joinIndir:G,parse:L,toElement:gt,toRange:tt},Symbol.toStringTag,{value:"Module"})),bt=n=>{let t=0;const e=s=>{if(s.id=t++,s.subitems)for(const o of s.subitems)e(o)};for(const s of n)e(s);return n},et=n=>n.map(t=>t.subitems?.length?[t,et(t.subitems)].flat():t).flat();class j{async init({toc:t,ids:e,splitHref:s,getFragment:o}){bt(t);const i=et(t),a=new Map;for(const[c,d]of i.entries()){const[l,h]=await s(d?.href)??[],f={fragment:h,item:d};a.has(l)?a.get(l).items.push(f):a.set(l,{prev:i[c-1],items:[f]})}const r=new Map;for(const[c,d]of e.entries())a.has(d)?r.set(d,a.get(d)):r.set(d,r.get(e[c-1]));this.ids=e,this.map=r,this.getFragment=o}getProgress(t,e){if(!this.ids)return;const s=this.ids[t],o=this.map.get(s);if(!o)return null;const{prev:i,items:a}=o;if(!a)return i;if(!e||a.length===1&&!a[0].fragment)return a[0].item;const r=e.startContainer.getRootNode();for(const[c,{fragment:d}]of a.entries()){const l=this.getFragment(r,d);if(l&&e.comparePoint(l,0)>0)return a[c-1]?.item??i}return a[a.length-1].item}}class yt{constructor(t,e,s){this.sizes=t.map(o=>o.linear!="no"&&o.size>0?o.size:0),this.sizePerLoc=e,this.sizePerTimeUnit=s,this.sizeTotal=this.sizes.reduce((o,i)=>o+i,0),this.sectionFractions=this.#e()}#e(){const{sizeTotal:t}=this,e=[0];let s=0;for(const o of this.sizes)e.push((s+=o)/t);return e}getProgress(t,e,s=0){const{sizes:o,sizePerLoc:i,sizePerTimeUnit:a,sizeTotal:r}=this,c=o[t]??0,l=o.slice(0,t).reduce((p,m)=>p+m,0)+e*c,h=l+s*c,f=r-l,u=(1-e)*c;return{fraction:h/r,section:{current:t,total:o.length},location:{current:Math.floor(l/i),next:Math.floor(h/i),total:Math.ceil(r/i)},time:{section:u/a,total:f/a}}}getSection(t){if(t<=0)return[0,0];if(t>=1)return[this.sizes.length-1,1];t=t+Number.EPSILON;const{sizeTotal:e}=this;let s=this.sectionFractions.findIndex(i=>i>t)-1;if(s<0)return[0,0];for(;!this.sizes[s];)s++;const o=(t-this.sectionFractions[s])/(this.sizes[s]/e);return[s,o]}}const v=n=>document.createElementNS("http://www.w3.org/2000/svg",n);class N{#e=v("svg");#t=new Map;constructor(){Object.assign(this.#e.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"})}get element(){return this.#e}add(t,e,s,o){this.#t.has(t)&&this.remove(t),typeof e=="function"&&(e=e(this.#e.getRootNode()));const i=e.getClientRects(),a=s(i,o);this.#e.append(a),this.#t.set(t,{range:e,draw:s,options:o,element:a,rects:i})}remove(t){this.#t.has(t)&&(this.#e.removeChild(this.#t.get(t).element),this.#t.delete(t))}redraw(){for(const t of this.#t.values()){const{range:e,draw:s,options:o,element:i}=t;this.#e.removeChild(i);const a=e.getClientRects(),r=s(a,o);this.#e.append(r),t.element=r,t.rects=a}}hitTest({x:t,y:e}){const s=Array.from(this.#t.entries());for(let o=s.length-1;o>=0;o--){const[i,a]=s[o];for(const{left:r,top:c,right:d,bottom:l}of a.rects)if(c<=e&&r<=t&&l>e&&d>t)return[i,a.range]}return[]}static underline(t,e={}){const{color:s="red",width:o=2,writingMode:i}=e,a=v("g");if(a.setAttribute("fill",s),i==="vertical-rl"||i==="vertical-lr")for(const{right:r,top:c,height:d}of t){const l=v("rect");l.setAttribute("x",r-o),l.setAttribute("y",c),l.setAttribute("height",d),l.setAttribute("width",o),a.append(l)}else for(const{left:r,bottom:c,width:d}of t){const l=v("rect");l.setAttribute("x",r),l.setAttribute("y",c-o),l.setAttribute("height",o),l.setAttribute("width",d),a.append(l)}return a}static strikethrough(t,e={}){const{color:s="red",width:o=2,writingMode:i}=e,a=v("g");if(a.setAttribute("fill",s),i==="vertical-rl"||i==="vertical-lr")for(const{right:r,left:c,top:d,height:l}of t){const h=v("rect");h.setAttribute("x",(r+c)/2),h.setAttribute("y",d),h.setAttribute("height",l),h.setAttribute("width",o),a.append(h)}else for(const{left:r,top:c,bottom:d,width:l}of t){const h=v("rect");h.setAttribute("x",r),h.setAttribute("y",(c+d)/2),h.setAttribute("height",o),h.setAttribute("width",l),a.append(h)}return a}static squiggly(t,e={}){const{color:s="red",width:o=2,writingMode:i}=e,a=v("g");a.setAttribute("fill","none"),a.setAttribute("stroke",s),a.setAttribute("stroke-width",o);const r=o*1.5;if(i==="vertical-rl"||i==="vertical-lr")for(const{right:c,top:d,height:l}of t){const h=v("path"),f=Math.round(l/r/1.5),u=l/f,p=Array.from({length:f},(m,w)=>`l${w%2?-r:r} ${u}`).join("");h.setAttribute("d",`M${c} ${d}${p}`),a.append(h)}else for(const{left:c,bottom:d,width:l}of t){const h=v("path"),f=Math.round(l/r/1.5),u=l/f,p=Array.from({length:f},(m,w)=>`l${u} ${w%2?r:-r}`).join("");h.setAttribute("d",`M${c} ${d}${p}`),a.append(h)}return a}static highlight(t,e={}){const{color:s="red"}=e,o=v("g");o.setAttribute("fill",s),o.style.opacity="var(--overlayer-highlight-opacity, .3)",o.style.mixBlendMode="var(--overlayer-highlight-blend-mode, normal)";for(const{left:i,top:a,height:r,width:c}of t){const d=v("rect");d.setAttribute("x",i),d.setAttribute("y",a),d.setAttribute("height",r),d.setAttribute("width",c),o.append(d)}return o}static outline(t,e={}){const{color:s="red",width:o=3,radius:i=3}=e,a=v("g");a.setAttribute("fill","none"),a.setAttribute("stroke",s),a.setAttribute("stroke-width",o);for(const{left:r,top:c,height:d,width:l}of t){const h=v("rect");h.setAttribute("x",r),h.setAttribute("y",c),h.setAttribute("height",d),h.setAttribute("width",l),h.setAttribute("rx",i),a.append(h)}return a}static copyImage([t],e={}){const{src:s}=e,o=v("image"),{left:i,top:a,height:r,width:c}=t;return o.setAttribute("href",s),o.setAttribute("x",i),o.setAttribute("y",a),o.setAttribute("height",r),o.setAttribute("width",c),o}}const Et=(n,t)=>{const e=[];for(let s=t.currentNode;s;s=t.nextNode()){const o=n.comparePoint(s,0);if(o===0)e.push(s);else if(o>0)break}return e},At=(n,t)=>{const e=[];for(let s=t.nextNode();s;s=t.nextNode())e.push(s);return e},Lt=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,Tt=n=>{if(n.nodeType===1){const t=n.tagName.toLowerCase();return t==="script"||t==="style"?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},V=function*(n,t,e){const s=n.commonAncestorContainer??n.body??n,o=document.createTreeWalker(s,Lt,{acceptNode:e||Tt}),a=(n.commonAncestorContainer?Et:At)(n,o),r=a.map(d=>d.nodeValue),c=(d,l,h,f)=>{const u=document.createRange();return u.setStart(a[d],l),u.setEnd(a[h],f),u};for(const d of t(r,c))yield d},A="foliate-search:",xt=async n=>{const t=new Uint8Array(await n.slice(0,4).arrayBuffer());return t[0]===80&&t[1]===75&&t[2]===3&&t[3]===4},kt=({name:n,type:t})=>t==="application/vnd.comicbook+zip"||n.endsWith(".cbz"),It=async n=>{const{configure:t,ZipReader:e,BlobReader:s,TextWriter:o,BlobWriter:i}=await y(async()=>{const{configure:u,ZipReader:p,BlobReader:m,TextWriter:w,BlobWriter:b}=await import("./zip-DR1K4mUw.js");return{configure:u,ZipReader:p,BlobReader:m,TextWriter:w,BlobWriter:b}},[],import.meta.url);t({useWebWorkers:!1});const r=await new e(new s(n)).getEntries(),c=new Map(r.map(u=>[u.filename,u])),d=u=>(p,...m)=>c.has(p)?u(c.get(p),...m):null,l=d(u=>u.getData(new o)),h=d((u,p)=>u.getData(new i(p)));return{entries:r,loadText:l,loadBlob:h,getSize:u=>c.get(u)?.uncompressedSize??0}},st=async n=>n.isFile?n:(await Promise.all(Array.from(await new Promise((t,e)=>n.createReader().readEntries(s=>t(s),s=>e(s))),st))).flat(),Pt=async n=>{const t=await st(n),e=await Promise.all(t.map(l=>new Promise((h,f)=>l.file(u=>h([u,l.fullPath]),u=>f(u))))),s=new Map(e.map(([l,h])=>[h.replace(n.fullPath+"/",""),l])),o=new TextDecoder,i=l=>l?o.decode(l):null,a=l=>s.get(l)?.arrayBuffer()??null;return{loadText:async l=>i(await a(l)),loadBlob:l=>s.get(l),getSize:l=>s.get(l)?.size??0}};class Ct extends Error{}class _t extends Error{}class St extends Error{}const Ft=async n=>{const t=await fetch(n);if(!t.ok)throw new Ct(`${t.status} ${t.statusText}`,{cause:t});return new File([await t.blob()],new URL(t.url).pathname)},Nt=async n=>{typeof n=="string"&&(n=await Ft(n));let t;if(n.isDirectory){const e=await Pt(n),{EPUB:s}=await y(async()=>{const{EPUB:o}=await import("./epub-FpEZHuK7.js");return{EPUB:o}},[],import.meta.url);t=await new s(e).init()}else if(n.size)if(await xt(n)){const e=await It(n);if(kt(n)){const{makeComicBook:s}=await y(async()=>{const{makeComicBook:o}=await import("./comic-book-nSTUk5ZP.js");return{makeComicBook:o}},[],import.meta.url);t=s(e,n)}else{const{EPUB:s}=await y(async()=>{const{EPUB:o}=await import("./epub-FpEZHuK7.js");return{EPUB:o}},[],import.meta.url);t=await new s(e).init()}}else{const{isMOBI:e,MOBI:s}=await y(async()=>{const{isMOBI:o,MOBI:i}=await import("./mobi-W5IBhVYb.js");return{isMOBI:o,MOBI:i}},[],import.meta.url);if(await e(n)){const o=await y(()=>import("./fflate-B2dMBbpR.js"),[],import.meta.url);t=await new s({unzlib:o.unzlibSync}).open(n)}}else throw new _t("File not found");if(!t)throw new St("File type not supported");return t};class O{#e;#t;#n;#s;constructor(t,e,s={}){this.#t=t,this.#n=e,this.#s=s,this.#s.hidden&&this.hide(),this.#t.addEventListener("mousemove",({screenX:o,screenY:i})=>{o===this.#s.x&&i===this.#s.y||(this.#s.x=o,this.#s.y=i,this.show(),this.#e&&clearTimeout(this.#e),e()&&(this.#e=setTimeout(this.hide.bind(this),1e3)))},!1)}cloneFor(t){return new O(t,this.#n,this.#s)}hide(){this.#t.style.cursor="none",this.#s.hidden=!0}show(){this.#t.style.removeProperty("cursor"),this.#s.hidden=!1}}class Rt extends EventTarget{#e=[];#t=-1;pushState(t){const e=this.#e[this.#t];e===t||e?.fraction&&e.fraction===t.fraction||(this.#e[++this.#t]=t,this.#e.length=this.#t+1,this.dispatchEvent(new Event("index-change")))}replaceState(t){const e=this.#t;this.#e[e]=t}back(){const t=this.#t;if(t<=0)return;const e={state:this.#e[t-1]};this.#t=t-1,this.dispatchEvent(new CustomEvent("popstate",{detail:e})),this.dispatchEvent(new Event("index-change"))}forward(){const t=this.#t;if(t>=this.#e.length-1)return;const e={state:this.#e[t+1]};this.#t=t+1,this.dispatchEvent(new CustomEvent("popstate",{detail:e})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return this.#t>0}get canGoForward(){return this.#t<this.#e.length-1}clear(){this.#e=[],this.#t=-1}}const Ot=n=>{if(!n)return{};try{const t=Intl.getCanonicalLocales(n)[0],e=new Intl.Locale(t),s=["zh","ja","kr"].includes(e.language),o=(e.getTextInfo?.()??e.textInfo)?.direction;return{canonical:t,locale:e,isCJK:s,direction:o}}catch(t){return console.warn(t),{}}};class $t extends HTMLElement{#e=this.attachShadow({mode:"closed"});#t;#n;#s;#i=new Map;#a=new O(this,()=>this.hasAttribute("autohide-cursor"));isFixedLayout=!1;lastLocation;history=new Rt;constructor(){super(),this.history.addEventListener("popstate",({detail:t})=>{const e=this.resolveNavigation(t.state);this.renderer.goTo(e)})}async open(t){if((typeof t=="string"||typeof t.arrayBuffer=="function"||t.isDirectory)&&(t=await Nt(t)),this.book=t,this.language=Ot(t.metadata?.language),t.splitTOCHref&&t.getTOCFragment){const e=t.sections.map(i=>i.id);this.#t=new yt(t.sections,1500,1600);const s=t.splitTOCHref.bind(t),o=t.getTOCFragment.bind(t);this.#n=new j,await this.#n.init({toc:t.toc??[],ids:e,splitHref:s,getFragment:o}),this.#s=new j,await this.#s.init({toc:t.pageList??[],ids:e,splitHref:s,getFragment:o})}if(this.isFixedLayout=this.book.rendition?.layout==="pre-paginated",this.isFixedLayout?(await y(()=>import("./fixed-layout-D4c9WMmo.js"),[],import.meta.url),this.renderer=document.createElement("foliate-fxl")):(await y(()=>import("./paginator-Ck4QNDHj.js"),[],import.meta.url),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter"),this.renderer.addEventListener("load",e=>this.#l(e.detail)),this.renderer.addEventListener("relocate",e=>this.#c(e.detail)),this.renderer.addEventListener("create-overlayer",e=>e.detail.attach(this.#h(e.detail))),this.renderer.open(t),this.#e.append(this.renderer),t.sections.some(e=>e.mediaOverlay)){const e=t.media.activeClass,s=t.media.playbackActiveClass;this.mediaOverlay=t.getMediaOverlay();let o;this.mediaOverlay.addEventListener("highlight",i=>{const a=this.resolveNavigation(i.detail.text);this.renderer.goTo(a).then(()=>{const{doc:r}=this.renderer.getContents().find(d=>d.index=a.index),c=a.anchor(r);c.classList.add(e),s&&c.ownerDocument.documentElement.classList.add(s),o=new WeakRef(c)})}),this.mediaOverlay.addEventListener("unhighlight",()=>{const i=o?.deref();i&&(i.classList.remove(e),s&&i.ownerDocument.documentElement.classList.remove(s))})}}close(){this.renderer?.destroy(),this.renderer?.remove(),this.#t=null,this.#n=null,this.#s=null,this.#i=new Map,this.lastLocation=null,this.history.clear(),this.tts=null,this.mediaOverlay=null}goToTextStart(){return this.goTo(this.book.landmarks?.find(t=>t.type.includes("bodymatter")||t.type.includes("text"))?.href??this.book.sections.findIndex(t=>t.linear!=="no"))}async init({lastLocation:t,showTextStart:e}){const s=t?this.resolveNavigation(t):null;s?(await this.renderer.goTo(s),this.history.pushState(t)):e?await this.goToTextStart():(this.history.pushState(0),await this.next())}#o(t,e,s){return this.dispatchEvent(new CustomEvent(t,{detail:e,cancelable:s}))}#c({reason:t,range:e,index:s,fraction:o,size:i}){const a=this.#t?.getProgress(s,o,i)??{},r=this.#n?.getProgress(s,e),c=this.#s?.getProgress(s,e),d=this.getCFI(s,e);this.lastLocation={...a,tocItem:r,pageItem:c,cfi:d,range:e},(t==="snap"||t==="page"||t==="scroll")&&this.history.replaceState(d),this.#o("relocate",this.lastLocation)}#l({doc:t,index:e}){t.documentElement.lang||=this.language.canonical??"",this.language.isCJK||(t.documentElement.dir||=this.language.direction??""),this.#d(t,e),this.#a.cloneFor(t.documentElement),this.#o("load",{doc:t,index:e})}#d(t,e){const{book:s}=this,o=s.sections[e];t.addEventListener("click",i=>{const a=i.target.closest("a[href]");if(!a)return;i.preventDefault();const r=a.getAttribute("href"),c=o?.resolveHref?.(r)??r;s?.isExternal?.(c)?Promise.resolve(this.#o("external-link",{a,href:c},!0)).then(d=>d?globalThis.open(c,"_blank"):null).catch(d=>console.error(d)):Promise.resolve(this.#o("link",{a,href:c},!0)).then(d=>d?this.goTo(c):null).catch(d=>console.error(d))})}async addAnnotation(t,e){const{value:s}=t;if(s.startsWith(A)){const c=s.replace(A,""),{index:d,anchor:l}=await this.resolveNavigation(c),h=this.#r(d);if(h){const{overlayer:f,doc:u}=h;if(e){f.remove(s);return}const p=u?l(u):l;f.add(s,p,N.outline)}return}const{index:o,anchor:i}=await this.resolveNavigation(s),a=this.#r(o);if(a){const{overlayer:c,doc:d}=a;if(c.remove(s),!e){const l=d?i(d):i,h=(f,u)=>c.add(s,l,f,u);this.#o("draw-annotation",{draw:h,annotation:t,doc:d,range:l})}}const r=this.#n.getProgress(o)?.label??"";return{index:o,label:r}}deleteAnnotation(t){return this.addAnnotation(t,!0)}#r(t){return this.renderer.getContents().find(e=>e.index===t&&e.overlayer)}#h({doc:t,index:e}){const s=new N;t.addEventListener("click",i=>{const[a,r]=s.hitTest(i);a&&!a.startsWith(A)&&this.#o("show-annotation",{value:a,index:e,range:r})},!1);const o=this.#i.get(e);if(o)for(const i of o)this.addAnnotation(i);return this.#o("create-overlay",{index:e}),s}async showAnnotation(t){const{value:e}=t,s=await this.goTo(e);if(s){const{index:o,anchor:i}=s,{doc:a}=this.#r(o),r=i(a);this.#o("show-annotation",{value:e,index:o,range:r})}}getCFI(t,e){const s=this.book.sections[t].cfi??I.fromIndex(t);return e?G(s,Y(e)):s}resolveCFI(t){if(this.book.resolveCFI)return this.book.resolveCFI(t);{const e=L(t);return{index:I.toIndex((e.parent??e).shift()),anchor:i=>tt(i,e)}}}resolveNavigation(t){try{if(typeof t=="number")return{index:t};if(typeof t.fraction=="number"){const[e,s]=this.#t.getSection(t.fraction);return{index:e,anchor:s}}return T.test(t)?this.resolveCFI(t):this.book.resolveHref(t)}catch(e){console.error(e),console.error(`Could not resolve target ${t}`)}}async goTo(t){const e=this.resolveNavigation(t);try{return await this.renderer.goTo(e),this.history.pushState(t),e}catch(s){console.error(s),console.error(`Could not go to ${t}`)}}async goToFraction(t){const[e,s]=this.#t.getSection(t);await this.renderer.goTo({index:e,anchor:s}),this.history.pushState({fraction:t})}async select(t){try{const e=await this.resolveNavigation(t);await this.renderer.goTo({...e,select:!0}),this.history.pushState(t)}catch(e){console.error(e),console.error(`Could not go to ${t}`)}}deselect(){for(const{doc:t}of this.renderer.getContents())t.defaultView.getSelection().removeAllRanges()}getSectionFractions(){return(this.#t?.sectionFractions??[]).map(t=>t+Number.EPSILON)}getProgressOf(t,e){const s=this.#n?.getProgress(t,e),o=this.#s?.getProgress(t,e);return{tocItem:s,pageItem:o}}async getTOCItemOf(t){try{const{index:e,anchor:s}=await this.resolveNavigation(t),o=await this.book.sections[e].createDocument(),i=s(o),a=i instanceof Range,r=a?i:o.createRange();return a||r.selectNodeContents(i),this.#n.getProgress(e,r)}catch(e){console.error(e),console.error(`Could not get ${t}`)}}async prev(t){await this.renderer.prev(t)}async next(t){await this.renderer.next(t)}goLeft(){return this.book.dir==="rtl"?this.next():this.prev()}goRight(){return this.book.dir==="rtl"?this.prev():this.next()}async*#u(t,e,s){const o=await this.book.sections[s].createDocument();for(const{range:i,excerpt:a}of t(o,e))yield{cfi:this.getCFI(s,i),excerpt:a}}async*#f(t,e){const{sections:s}=this.book;for(const[o,{createDocument:i}]of s.entries()){if(!i)continue;const a=await i(),r=Array.from(t(a,e),({range:d,excerpt:l})=>({cfi:this.getCFI(o,d),excerpt:l}));yield{progress:(o+1)/s.length},r.length&&(yield{index:o,subitems:r})}}async*search(t){this.clearSearch();const{searchMatcher:e}=await y(async()=>{const{searchMatcher:c}=await import("./search-UHG1SVDO.js");return{searchMatcher:c}},[],import.meta.url),{query:s,index:o}=t,i=e(V,{defaultLocale:this.language,...t}),a=o!=null?this.#u(i,s,o):this.#f(i,s),r=[];this.#i.set(o,r);for await(const c of a)if(c.subitems){const d=c.subitems.map(({cfi:l})=>({value:A+l}));this.#i.set(c.index,d);for(const l of d)this.addAnnotation(l);yield{label:this.#n.getProgress(c.index)?.label??"",subitems:c.subitems}}else{if(c.cfi){const d={value:A+c.cfi};r.push(d),this.addAnnotation(d)}yield c}yield"done"}clearSearch(){for(const t of this.#i.values())for(const e of t)this.deleteAnnotation(e);this.#i.clear()}async initTTS(t="word",e){const s=this.renderer.getContents()[0].doc;if(this.tts&&this.tts.doc===s)return;const{TTS:o}=await y(async()=>{const{TTS:i}=await import("./tts-ColYPQ7G.js");return{TTS:i}},[],import.meta.url);this.tts=new o(s,V,e||(i=>this.renderer.scrollToAnchor(i,!0)),t)}startMediaOverlay(){const{index:t}=this.renderer.getContents()[0];return this.mediaOverlay.start(t)}}customElements.define("foliate-view",$t);const W=n=>document.createElementNS("http://www.w3.org/2000/svg",n),Bt=()=>{const n=W("svg");n.setAttribute("viewBox","0 0 13 10"),n.setAttribute("width","13"),n.setAttribute("height","13");const t=W("polygon");return t.setAttribute("points","2 1, 12 1, 7 9"),n.append(t),n},Mt=(n,t,e)=>{let s=0;const o=()=>`toc-element-${s++}`,i=({label:a,href:r,subitems:c},d=0)=>{const l=document.createElement(r?"a":"span");l.innerText=a,l.setAttribute("role","treeitem"),l.tabIndex=-1,l.style.paddingInlineStart=`${(d+1)*24}px`,n.push(l),r?(t.has(r)||t.set(r,l),l.href=r,l.onclick=f=>{f.preventDefault(),e(r)}):l.onclick=f=>l.firstElementChild?.onclick(f);const h=document.createElement("li");if(h.setAttribute("role","none"),h.append(l),c?.length){l.setAttribute("aria-expanded","false");const f=Bt();f.onclick=p=>{p.preventDefault(),p.stopPropagation();const m=l.getAttribute("aria-expanded");l.setAttribute("aria-expanded",m==="true"?"false":"true")},l.prepend(f);const u=document.createElement("ol");u.id=o(),u.setAttribute("role","group"),l.setAttribute("aria-owns",u.id),u.replaceChildren(...c.map(p=>i(p,d+1))),h.append(u)}return h};return i},zt=(n,t)=>{const e=document.createElement("ol");e.setAttribute("role","tree");const s=[],o=new Map,i=Mt(s,o,t);e.replaceChildren(...n.map(p=>i(p)));const a=p=>p?.getAttribute("role")==="treeitem",r=function*(p){for(let m=p.parentNode;m!==e;m=m.parentNode){const w=m.previousElementSibling;a(w)&&(yield w)}};let c,d;e.addEventListener("focusout",()=>{if(c){if(d&&(d.tabIndex=-1),c.offsetParent){c.tabIndex=0;return}for(const p of r(c))if(p.offsetParent){p.tabIndex=0,d=p;break}}});const l=p=>{c&&(c.removeAttribute("aria-current"),c.tabIndex=-1);const m=o.get(p);if(!m){c=s[0],c.tabIndex=0;return}for(const w of r(m))w.setAttribute("aria-expanded","true");m.setAttribute("aria-current","page"),m.tabIndex=0,m.scrollIntoView({behavior:"smooth",block:"center"}),c=m},h=p=>a(p)&&p.offsetParent?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP,f=document.createTreeWalker(e,1,{acceptNode:h}),u=p=>(f.currentNode=p,f);for(const p of s)p.addEventListener("keydown",m=>{let w=!1;const{currentTarget:b,key:it}=m;switch(it){case" ":case"Enter":b.click(),w=!0;break;case"ArrowDown":u(b).nextNode()?.focus(),w=!0;break;case"ArrowUp":u(b).previousNode()?.focus(),w=!0;break;case"ArrowLeft":b.getAttribute("aria-expanded")==="true"?b.setAttribute("aria-expanded","false"):r(b).next()?.value?.focus(),w=!0;break;case"ArrowRight":b.getAttribute("aria-expanded")==="true"?u(b).nextNode()?.focus():b.getAttribute("aria-owns")&&b.setAttribute("aria-expanded","true"),w=!0;break;case"Home":s[0].focus(),w=!0;break;case"End":{const C=s[s.length-1];C.offsetParent?C.focus():u(C).previousNode()?.focus(),w=!0;break}}w&&(m.preventDefault(),m.stopPropagation())});return{element:e,setCurrentHref:l}},Dt=(n,t,e)=>{const s=document.createElement("ul");s.setAttribute("role","group"),s.setAttribute("aria-label",n);const o=new Map,i=a=>{e(a);const r=o.get(a);for(const c of s.children)c.setAttribute("aria-checked",c===r?"true":"false")};for(const[a,r]of t){const c=document.createElement("li");c.setAttribute("role","menuitemradio"),c.innerText=a,c.onclick=()=>i(r),o.set(r,c),s.append(c)}return{element:s,select:i}},jt=n=>{const t={},e=document.createElement("ul");e.setAttribute("role","menu");const s=()=>e.classList.remove("show"),o=i=>(...a)=>(s(),i(...a));for(const{name:i,label:a,type:r,items:c,onclick:d}of n){const l=r==="radio"?Dt(a,c,o(d)):null;i&&(t[i]=l),e.append(l.element)}return window.addEventListener("blur",()=>s()),window.addEventListener("click",i=>{e.parentNode.contains(i.target)||s()}),{element:e,groups:t}},Vt=({spacing:n,justify:t,hyphenate:e})=>`
    @namespace epub "http://www.idpf.org/2007/ops";
    html {
        color-scheme: light dark;
    }
    /* https://github.com/whatwg/html/issues/5426 */
    @media (prefers-color-scheme: dark) {
        a:link {
            color: lightblue;
        }
    }
    p, li, blockquote, dd {
        line-height: ${n};
        text-align: ${t?"justify":"start"};
        -webkit-hyphens: ${e?"auto":"manual"};
        hyphens: ${e?"auto":"manual"};
        -webkit-hyphenate-limit-before: 3;
        -webkit-hyphenate-limit-after: 2;
        -webkit-hyphenate-limit-lines: 2;
        hanging-punctuation: allow-end last;
        widows: 2;
    }
    /* prevent the above from overriding the align attribute */
    [align="left"] { text-align: left; }
    [align="right"] { text-align: right; }
    [align="center"] { text-align: center; }
    [align="justify"] { text-align: justify; }

    pre {
        white-space: pre-wrap !important;
    }
    aside[epub|type~="endnote"],
    aside[epub|type~="footnote"],
    aside[epub|type~="note"],
    aside[epub|type~="rearnote"] {
        display: none;
    }
`,g=document.querySelector.bind(document),nt="en",Wt=new Intl.NumberFormat(nt,{style:"percent"}),Ht=new Intl.ListFormat(nt,{style:"short",type:"conjunction"}),ot=n=>{if(!n)return"";if(typeof n=="string")return n;const t=Object.keys(n);return n[t[0]]},H=n=>typeof n=="string"?n:ot(n?.name),Ut=n=>Array.isArray(n)?Ht.format(n.map(H)):H(n);class qt{#e;style={spacing:1.4,justify:!0,hyphenate:!0};annotations=new Map;annotationsByValue=new Map;closeSideBar(){g("#dimming-overlay").classList.remove("show"),g("#side-bar").classList.remove("show")}constructor(){g("#side-bar-button").addEventListener("click",()=>{g("#dimming-overlay").classList.add("show"),g("#side-bar").classList.add("show")}),g("#dimming-overlay").addEventListener("click",()=>this.closeSideBar());const t=jt([{name:"layout",label:"Layout",type:"radio",items:[["Paginated","paginated"],["Scrolled","scrolled"]],onclick:e=>{this.view?.renderer.setAttribute("flow",e)}}]);t.element.classList.add("menu"),g("#menu-button").append(t.element),g("#menu-button > button").addEventListener("click",()=>t.element.classList.toggle("show")),t.groups.layout.select("paginated")}async open(t){this.view=document.createElement("foliate-view"),document.body.append(this.view),await this.view.open(t),this.view.addEventListener("load",this.#n.bind(this)),this.view.addEventListener("relocate",this.#s.bind(this));const{book:e}=this.view;e.transformTarget?.addEventListener("data",({detail:r})=>{r.data=Promise.resolve(r.data).catch(c=>(console.error(new Error(`Failed to load ${r.name}`,{cause:c})),""))}),this.view.renderer.setStyles?.(Vt(this.style)),this.view.renderer.next(),g("#header-bar").style.visibility="visible",g("#nav-bar").style.visibility="visible",g("#left-button").addEventListener("click",()=>this.view.goLeft()),g("#right-button").addEventListener("click",()=>this.view.goRight());const s=g("#progress-slider");s.dir=e.dir,s.addEventListener("input",r=>this.view.goToFraction(parseFloat(r.target.value)));for(const r of this.view.getSectionFractions()){const c=document.createElement("option");c.value=r,g("#tick-marks").append(c)}document.addEventListener("keydown",this.#t.bind(this));const o=ot(e.metadata?.title)||"Untitled Book";document.title=o,g("#side-bar-title").innerText=o,g("#side-bar-author").innerText=Ut(e.metadata?.author),Promise.resolve(e.getCover?.())?.then(r=>r?g("#side-bar-cover").src=URL.createObjectURL(r):null);const i=e.toc;i&&(this.#e=zt(i,r=>{this.view.goTo(r).catch(c=>console.error(c)),this.closeSideBar()}),g("#toc-view").append(this.#e.element));const a=await e.getCalibreBookmarks?.();if(a){const{fromCalibreHighlight:r}=await y(async()=>{const{fromCalibreHighlight:c}=await Promise.resolve().then(()=>vt);return{fromCalibreHighlight:c}},void 0,import.meta.url);for(const c of a)if(c.type==="highlight"){const d=r(c),l=c.style.which,h=c.notes,f={value:d,color:l,note:h},u=this.annotations.get(c.spine_index);u?u.push(f):this.annotations.set(c.spine_index,[f]),this.annotationsByValue.set(d,f)}this.view.addEventListener("create-overlay",c=>{const{index:d}=c.detail,l=this.annotations.get(d);if(l)for(const h of l)this.view.addAnnotation(h)}),this.view.addEventListener("draw-annotation",c=>{const{draw:d,annotation:l}=c.detail,{color:h}=l;d(N.highlight,{color:h})}),this.view.addEventListener("show-annotation",c=>{const d=this.annotationsByValue.get(c.detail.value);d.note&&alert(d.note)})}}#t(t){const e=t.key;e==="ArrowLeft"||e==="h"?this.view.goLeft():(e==="ArrowRight"||e==="l")&&this.view.goRight()}#n({detail:{doc:t}}){t.addEventListener("keydown",this.#t.bind(this))}#s({detail:t}){const{fraction:e,location:s,tocItem:o,pageItem:i}=t,a=Wt.format(e),r=i?`Page ${i.label}`:`Loc ${s.current}`,c=g("#progress-slider");c.style.visibility="visible",c.value=e,c.title=`${a} Â· ${r}`,o?.href&&this.#e?.setCurrentHref?.(o.href)}}const $=async n=>{document.body.removeChild(g("#drop-target"));const t=new qt;globalThis.reader=t,await t.open(n)},Kt=n=>n.preventDefault(),Gt=n=>{n.preventDefault();const t=Array.from(n.dataTransfer.items).find(e=>e.kind==="file");if(t){const e=t.webkitGetAsEntry();$(e.isFile?t.getAsFile():e).catch(s=>console.error(s))}},B=g("#drop-target");B.addEventListener("drop",Gt);B.addEventListener("dragover",Kt);g("#file-input").addEventListener("change",n=>$(n.target.files[0]).catch(t=>console.error(t)));g("#file-button").addEventListener("click",()=>g("#file-input").click());const Zt=new URLSearchParams(location.search),U=Zt.get("url");U?$(U).catch(n=>console.error(n)):B.style.visibility="visible";export{tt as a,mt as f,L as p,gt as t};
