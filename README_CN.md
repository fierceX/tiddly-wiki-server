# TiddlyWiki æœåŠ¡ç«¯ (Rust å¢å¼ºç‰ˆ)

[![Contributor Covenant](https://img.shields.io/badge/Contributor%20Covenant-2.1-4baaaa.svg)](code_of_conduct.md)
![Rust Version](https://img.shields.io/badge/rust-1.75%2B-orange)
![License](https://img.shields.io/badge/license-Prosperity%20Public-blue)

[English](./README.md)

è¿™æ˜¯ä¸€ä¸ªä¸º [TiddlyWiki] è®¾è®¡çš„é«˜æ•ˆã€ä½ç»´æŠ¤ä¸”åŠŸèƒ½ä¸°å¯Œçš„ Web æœåŠ¡ç«¯ã€‚å®ƒæ˜¯åŸç‰ˆ [tiddly-wiki-server](https://github.com/nknight/tiddly-wiki-server) çš„ Rust é‡å†™ç‰ˆï¼Œæ—¨åœ¨æä¾›æ›´å¼ºçš„æ€§èƒ½ã€æ›´å®Œå–„çš„æ–‡ä»¶ç®¡ç†ã€äº‘å­˜å‚¨é›†æˆä»¥åŠå¿«é€Ÿé‡‡é›†èƒ½åŠ›ã€‚

è¯¥æœåŠ¡ç«¯åˆ©ç”¨ [TiddlyWeb æ’ä»¶] æä¾›çš„ [Web Server API]ï¼Œå°†æ¡ç›®ï¼ˆTiddlersï¼‰ä¿å­˜åœ¨ [SQLite æ•°æ®åº“] ä¸­ï¼ŒåŒæ—¶èƒ½å¤Ÿæ™ºèƒ½åœ°å°†å›¾ç‰‡ã€PDF ç­‰äºŒè¿›åˆ¶æ–‡ä»¶åˆ†ç¦»å­˜å‚¨åˆ°æœ¬åœ°ç£ç›˜æˆ–å…¼å®¹ S3 çš„äº‘å­˜å‚¨ä¸­ã€‚

[TiddlyWiki]: https://tiddlywiki.com/
[Web Server API]: https://tiddlywiki.com/#WebServer
[SQLite æ•°æ®åº“]: https://sqlite.org/index.html
[TiddlyWeb æ’ä»¶]: https://github.com/Jermolene/TiddlyWiki5/tree/master/plugins/tiddlywiki/tiddlyweb

## æ ¸å¿ƒæ”¹è¿›ä¸ç‰¹æ€§

ä¸åŸç‰ˆå®ç°ç›¸æ¯”ï¼Œæœ¬åˆ†æ”¯åŒ…å«äº†ä»¥ä¸‹é‡å¤§æ”¹è¿›ï¼š

### ğŸš€ æ€§èƒ½ä¸æ¸²æŸ“
-   **ä¼˜åŒ–çš„ Wiki æ¸²æŸ“**ï¼šé€šè¿‡é«˜æ•ˆçš„å†…å­˜æ‹†åˆ†æŠ€æœ¯ï¼Œå°†æ¡ç›®åŠ¨æ€æ³¨å…¥åˆ° `empty.html` æ¨¡æ¿ä¸­ï¼Œå¤§å¹…æå‡åŠ è½½é€Ÿåº¦ã€‚
-   **æä½èµ„æºå ç”¨**ï¼šè¿è¡Œæ—¶ä»…éœ€çº¦ 10MB å†…å­˜ï¼Œè€Œæ ‡å‡†çš„ NodeJS ç‰ˆæœåŠ¡ç«¯é€šå¸¸éœ€è¦ 70MB+ã€‚

### ğŸ“– é›†æˆ EPUB é˜…è¯»å™¨
-   **ç›´æ¥é˜…è¯»**ï¼šæœåŠ¡ç«¯äºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥å†…åµŒäº†è‡ªå®šä¹‰çš„ [Foliate-js](https://github.com/johnfactotum/foliate-js) é˜…è¯»å™¨ã€‚
-   **æ— ç¼ä½“éªŒ**ï¼šè‡ªåŠ¨æ£€æµ‹ `application/epub+zip` ç±»å‹çš„æ¡ç›®ï¼ˆé€šè¿‡ `_canonical_uri` å¼•ç”¨ï¼‰ï¼Œå¹¶åœ¨ç°ä»£åŒ–çš„é˜…è¯»ç•Œé¢ä¸­æ¸²æŸ“ï¼Œæ›¿æ¢é»˜è®¤çš„â€œäºŒè¿›åˆ¶æ–‡ä»¶â€ä¸‹è½½æç¤ºã€‚
-   **S3 & æœ¬åœ°æ”¯æŒ**ï¼šæ”¯æŒç›´æ¥ä» S3 æˆ–æœ¬åœ°å­˜å‚¨æµå¼ä¼ è¾“ EPUB æ–‡ä»¶ï¼Œæ— éœ€å…ˆå®Œæ•´ä¸‹è½½ã€‚
-   **å…³äº CSP çš„è¯´æ˜**ï¼šæ­¤å†…åµŒé˜…è¯»å™¨**ä¸ä¼š**æ‰§è¡Œå®¢æˆ·ç«¯çš„å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) æ¸…æ´—ã€‚å¦‚æœä½ å¯¼å…¥çš„æ˜¯ç”± Readeck ç­‰å·¥å…·ç”Ÿæˆä¸”æ³¨å…¥äº†ä¸¥æ ¼ CSP meta æ ‡ç­¾çš„ EPUB æ–‡ä»¶ï¼Œè¯·ç¡®ä¿åœ¨ä¸Šä¼ å‰å¯¹æ–‡ä»¶è¿›è¡Œæ¸…æ´—/å»æ¯’ã€‚

### â˜ï¸ æ™ºèƒ½å­˜å‚¨ (S3 & æœ¬åœ°)
-   **æœ¬åœ°æ–‡ä»¶åˆ†ç¦»**ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€PDF ç­‰ï¼‰ä¸å†ä»¥ Base64 å­—ç¬¦ä¸²å½¢å¼å­˜å…¥æ•°æ®åº“ï¼Œè€Œæ˜¯è‡ªåŠ¨ä¿å­˜åˆ° `files/` ç›®å½•ã€‚Tiddler ä»…ä¿ç•™ `_canonical_uri` å¼•ç”¨ï¼Œç¡®ä¿æ•°æ®åº“è½»é‡ä¸” Wiki è¿è¡Œæµç•…ã€‚
-   **S3/R2 ç›´ä¼ æ”¯æŒ**ï¼š
    -   æœåŠ¡ç«¯ç”Ÿæˆé¢„ç­¾å URL (Pre-signed URL)ï¼Œæµè§ˆå™¨ç›´æ¥å°†æ–‡ä»¶ä¸Šä¼ è‡³å¯¹è±¡å­˜å‚¨ã€‚
    -   èŠ‚çœæœåŠ¡å™¨å¸¦å®½ï¼Œæ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼Œæ— éœ€ç»è¿‡åº”ç”¨æœåŠ¡å™¨ä¸­è½¬ã€‚
-   **åŸºäºå…ƒæ•°æ®çš„å¥å£®æ€§**ï¼šTiddler å†…éƒ¨å­—æ®µï¼ˆ`_s3_key`, `_s3_bucket` ç­‰ï¼‰ç›´æ¥è®°å½•äº†æ–‡ä»¶çš„å­˜å‚¨å…ƒæ•°æ®ã€‚è¿™æ„å‘³ç€å³ä½¿æœåŠ¡å™¨é…ç½®å˜æ›´ï¼ˆå¦‚æ›´æ¢ Bucketï¼‰ï¼Œæ—§æ–‡ä»¶çš„ç®¡ç†å’Œåˆ é™¤ä¾ç„¶å‡†ç¡®æ— è¯¯ã€‚
-   **çº§è”åˆ é™¤ (Cascade Delete)**ï¼šå½“ä½ åœ¨ Wiki ä¸­åˆ é™¤ä¸€ä¸ªæ¡ç›®æ—¶ï¼ŒæœåŠ¡ç«¯ä¼š**è‡ªåŠ¨æ¸…ç†** S3 ä¸Šæˆ–æœ¬åœ°ç£ç›˜å¯¹åº”çš„æ–‡ä»¶ã€‚å½»åº•å‘Šåˆ«â€œå­¤å„¿æ–‡ä»¶â€å’Œå­˜å‚¨åƒåœ¾ã€‚

### ğŸ”’ å®‰å…¨ä¸è®¤è¯
-   **åŸºç¡€è®¤è¯ (Basic Auth)**ï¼šå†…ç½® HTTP Basic Auth ä¸­é—´ä»¶ï¼Œä¿æŠ¤éƒ¨ç½²åœ¨å…¬ç½‘çš„ Wiki ä¸è¢«æœªæˆæƒè®¿é—®ã€‚
-   **API é‰´æƒ**ï¼šæ”¯æŒæ ‡å‡†çš„ `Authorization` è¯·æ±‚å¤´ï¼Œæ–¹ä¾¿ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆã€‚

### ğŸ“¥ å¿«é€Ÿé‡‡é›† (Inbox)
-   æä¾›ä¸“ç”¨çš„ Webhook ç«¯ç‚¹ (`/api/inbox`)ï¼Œä¸“ä¸ºç§»åŠ¨ç«¯è‡ªåŠ¨åŒ–è®¾è®¡ã€‚
-   è½»æ¾é›†æˆ **iOS å¿«æ·æŒ‡ä»¤ (Shortcuts)** æˆ– **Android HTTP Shortcuts**ï¼Œæ— éœ€åŠ è½½å®Œæ•´çš„ Wiki ç•Œé¢å³å¯ç¬é—´æ•æ‰çµæ„Ÿã€‚

## é…ç½®æŒ‡å—

åœ¨å·¥ä½œç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `config.toml` æ–‡ä»¶ã€‚

> **å®‰å…¨æç¤º**ï¼šå¦‚æœå¯ç”¨äº†åŸºç¡€è®¤è¯ (`[auth]`)ï¼Œå¼ºçƒˆå»ºè®®é…åˆåå‘ä»£ç†ï¼ˆå¦‚ Nginx/Caddyï¼‰å¹¶å¼€å¯ **HTTPS**ï¼Œå› ä¸ºå¯†ç æ˜¯ä»¥ Base64 ç¼–ç ä¼ è¾“çš„ã€‚

```toml
[server]
bind = "0.0.0.0"
port = 3032
db_path = "./data/tiddlers.sqlite3"  # æ•°æ®åº“å­˜å‚¨è·¯å¾„
files_dir = "./files/"               # æœ¬åœ°æ–‡ä»¶å­˜å‚¨è·¯å¾„

# åœ¨ Wiki ä¿®è®¢è®°å½•ä¸­æ˜¾ç¤ºçš„ç”¨æˆ·å
[status]
username = "YourName" 

# [å¯é€‰] HTTP åŸºç¡€è®¤è¯
# å¦‚æœæ³¨é‡Šæ‰æ­¤éƒ¨åˆ†ï¼ŒæœåŠ¡å™¨å°†å…è®¸åŒ¿åè®¿é—®
[auth]
username = "admin"
password = "change_me_please"

[s3]
enable = true
name = "r2"
access_key = "YOUR_AWS_ACCESS_KEY"
secret_key = "YOUR_AWS_SECRET_KEY"
# ç¤ºä¾‹ï¼šCloudflare R2 çš„ endpoint
endpoint = "https://<ACCOUNT_ID>.r2.cloudflarestorage.com"
region = "auto"
bucket_name = "your-wiki-assets"
# ä½ çš„èµ„æºå…¬å¼€è®¿é—®åŸŸå
public_url_base = "https://assets.your-domain.com"
```

## å¿«é€Ÿé‡‡é›† API (Inbox)

æ— éœ€æ‰“å¼€ Wiki å³å¯ä»å¤–éƒ¨å·¥å…·å¿«é€Ÿä¿å­˜å†…å®¹ã€‚

-   **ç«¯ç‚¹**: `POST /api/inbox`
-   **Content-Type**: `application/json`

### JSON æ•°æ®æ ¼å¼

```json
{
  "text": "è¿™æ˜¯ä¸€æ¡ä»æ‰‹æœºå‘é€çš„é€Ÿè®°ã€‚",
  "tags": "idea mobile" 
}
```
*`tags` æ˜¯å¯é€‰çš„ã€‚å¦‚æœçœç•¥ï¼Œé»˜è®¤æ ‡ç­¾ä¸º "Inbox"ã€‚*

### iOS / Android å¿«æ·æŒ‡ä»¤ç¤ºä¾‹
*   **URL**: `https://your-wiki.com/api/inbox`
*   **æ–¹æ³•**: `POST`
*   **å¤´éƒ¨ (Headers)**: `Authorization: Basic <Base64ç¼–ç çš„è´¦å·å¯†ç >`
*   **è¯·æ±‚ä½“ (Body)**: JSON (å°†å‰ªè´´æ¿å†…å®¹æˆ–è¾“å…¥æ–‡æœ¬ä½œä¸º `text` å­—æ®µå‘é€)

é‡‡é›†çš„å†…å®¹å°†ä½œä¸ºä¸€ä¸ªå¸¦æœ‰æ—¶é—´æˆ³æ ‡é¢˜çš„æ–°æ¡ç›®å‡ºç°åœ¨ Wiki ä¸­ï¼Œå¹¶å¸¦æœ‰ `Inbox` æ ‡ç­¾ã€‚

## å®‰è£…ä¸è¿è¡Œ

1.  **ç¼–è¯‘**:
    ```sh
    cargo build --release
    ```
2.  **è¿è¡Œ**:
    ç¡®ä¿ `config.toml` å’Œ `empty.html` ä½äºå½“å‰ç›®å½•ä¸­ã€‚
    ```sh
    ./target/release/tiddly-wiki-server --config config.toml
    ```

## å¼€å‘æŒ‡å—ï¼šæ’ä»¶ä¸é™æ€èµ„æº

æœ¬æœåŠ¡ç«¯å†…åµŒäº†è‡ªå®šä¹‰çš„ TiddlyWiki æ’ä»¶å’Œé™æ€èµ„æºï¼ˆå¦‚é˜…è¯»å™¨ï¼‰ã€‚ä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼š

### 1. S3 ä¸Šä¼ æ’ä»¶ (S3 Uploader)
å¤„ç†æ‹–æ‹½ä¸Šä¼ è‡³ S3/æœ¬åœ°å­˜å‚¨çš„é€»è¾‘ã€‚
*   **æºç ä½ç½®**: `s3_uploader/`
*   **æ‰“åŒ…å‘½ä»¤**:
    ```sh
    cargo run --bin pack_plugin -- ./s3_uploader/manifest.json ./s3_uploader_plugin.json
    ```

### 2. EPUB é˜…è¯»å™¨æ’ä»¶ (EPUB Viewer Plugin)
å¤„ç† TiddlyWiki UI ä¸ EPUB æ–‡ä»¶çš„é›†æˆé€»è¾‘ã€‚
*   **æºç ä½ç½®**: `epub_plugin/`
*   **æ‰“åŒ…å‘½ä»¤**:
    ```sh
    cargo run --bin pack_plugin -- ./epub_plugin/manifest.json ./epub_viewer_plugin.json
    ```

### 3. Foliate é˜…è¯»å™¨ (å†…åµŒé™æ€èµ„æº)
å®é™…çš„é˜…è¯»å¼•æ“æ˜¯ Foliate-js çš„å®šåˆ¶æ„å»ºç‰ˆï¼Œç›´æ¥åµŒå…¥åœ¨æœåŠ¡ç«¯äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚
*   **æºç ä½ç½®**: `web/foliate-js/` (åŒ…å«ä¿®æ”¹åçš„æºä»£ç )
*   **æ„å»ºäº§ç‰©**: `web/foliate-js/ebook_reader/` (Rust åµŒå…¥çš„ä¼˜åŒ–åçš„é™æ€æ–‡ä»¶)
*   **å¦‚ä½•æ›´æ–°**: 
    å¦‚æœä½ ä¿®æ”¹äº†é˜…è¯»å™¨çš„æºä»£ç ï¼Œå¿…é¡»åœ¨é‡æ–°ç¼–è¯‘ Rust æœåŠ¡ç«¯ä¹‹å‰é‡å»ºå‰ç«¯èµ„æºï¼š
    ```sh
    cd web/foliate
    npm install
    npx vite build
    # ç¡®ä¿è¾“å‡ºä½äº ./ebook_reader ä¸”åŒ…å« reader.html
    ```

ä¿®æ”¹ä»»ä½•æ’ä»¶æˆ–èµ„æºåï¼Œè¯·è¿è¡Œ `cargo build` ä»¥å°†æ–°ç‰ˆæœ¬åµŒå…¥åˆ°æœåŠ¡ç«¯å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [The Prosperity Public License 3.0.0] è®¸å¯è¯å‘å¸ƒã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Pull Requestã€‚å¯¹äºé‡å¤§æ›´æ”¹ï¼Œè¯·å…ˆæäº¤ Issue è¿›è¡Œè®¨è®ºã€‚

## è¡Œä¸ºå‡†åˆ™ (Code of Conduct)

è´¡çŒ®è€…éœ€éµå®ˆ [Contributor Covenant](https://www.contributor-covenant.org/)ã€‚