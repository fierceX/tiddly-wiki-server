[
  {
    "author": "fiercex",
    "description": "S3 Lazy Uploader backed by Rust",
    "name": "S3 Uploader",
    "plugin-type": "plugin",
    "text": "{\"tiddlers\":{\"$:/plugins/custom/s3-uploader.js\":{\"module-type\":\"startup\",\"text\":\"/*\\\\\\ntitle: $:/plugins/custom/s3-uploader.js\\ntype: application/javascript\\nmodule-type: startup\\n\\nS3 Direct Uploader (With Native-like Import Report & Metadata Storage)\\n\\\\*/\\n(function() {\\n\\n/*jslint node: true, browser: true */\\n/*global $tw: false */\\n\\\"use strict\\\";\\n\\nexports.name = \\\"s3-uploader\\\";\\nexports.platforms = [\\\"browser\\\"];\\nexports.after = [\\\"startup\\\"];\\nexports.synchronous = true;\\n\\n// Global state\\n$tw.s3PendingFiles = [];\\n$tw.s3SuccessList = [];\\n\\nexports.startup = function() {\\n    console.log(\\\"✅ S3 Uploader: Initializing...\\\");\\n    if(typeof window !== 'undefined') {\\n        window.addEventListener(\\\"dragenter\\\", onDragOver, true);\\n        window.addEventListener(\\\"dragover\\\", onDragOver, true);\\n        window.addEventListener(\\\"drop\\\", onDrop, true);\\n    }\\n    // 监听模态框确认按钮的消息\\n    $tw.rootWidget.addEventListener(\\\"tm-s3-confirm-upload\\\", function(event) {\\n        $tw.s3SuccessList = [];\\n        processQueue();\\n    });\\n};\\n\\nfunction onDragOver(event) { \\n    event.preventDefault(); \\n}\\n\\nfunction onDrop(event) {\\n    var dataTransfer = event.dataTransfer;\\n    if (!dataTransfer || !dataTransfer.files || dataTransfer.files.length === 0) return;\\n    \\n    var file = dataTransfer.files[0];\\n    \\n    // 过滤掉普通的 TiddlyWiki 导入文件，交给核心处理\\n    if (file.name.endsWith(\\\".tid\\\") || file.name.endsWith(\\\".json\\\") || file.name.endsWith(\\\".html\\\")) return;\\n    \\n    event.preventDefault();\\n    event.stopPropagation();\\n    event.stopImmediatePropagation();\\n    \\n    $tw.s3PendingFiles = [file];\\n    \\n    var fileInfo = \\\"<strong>File:</strong> \\\" + file.name + \\\"<br/><strong>Size:</strong> \\\" + (file.size / 1024 / 1024).toFixed(2) + \\\" MB\\\";\\n    \\n    // 创建预览状态条目\\n    $tw.wiki.addTiddler(new $tw.Tiddler({title: \\\"$:/state/s3-upload-preview\\\", text: fileInfo}));\\n    \\n    // 打开确认模态框\\n    $tw.modal.display(\\\"$:/plugins/custom/s3-uploader/ui-modal\\\");\\n}\\n\\nfunction processQueue() {\\n    if ($tw.s3PendingFiles.length === 0) { \\n        finishBatch(); \\n        return; \\n    }\\n    var file = $tw.s3PendingFiles.shift();\\n    uploadToS3(file);\\n}\\n\\nfunction finishBatch() {\\n    if ($tw.s3SuccessList.length === 0) return;\\n    \\n    var listText = \\\"The following files were successfully uploaded to S3 (Lazy Loaded):\\\\n\\\\n\\\";\\n    $tw.s3SuccessList.forEach(function(title) { \\n        listText += \\\"* [[\\\" + title + \\\"]]\\\\n\\\"; \\n    });\\n    \\n    var reportTitle = \\\"$:/plugins/custom/s3-uploader/ui-report\\\";\\n    \\n    // 创建导入报告条目\\n    $tw.wiki.addTiddler(new $tw.Tiddler({\\n        title: reportTitle, \\n        text: listText, \\n        tags: [\\\"$:/tags/ImportResult\\\"], \\n        \\\"caption\\\": \\\"S3 Upload Report\\\", \\n        \\\"icon\\\": \\\"$:/core/images/cloud\\\"\\n    }));\\n    \\n    $tw.notifier.display(\\\"✅ Batch upload complete\\\");\\n    openTiddler(reportTitle);\\n}\\n\\nfunction openTiddler(title) {\\n    var storyList = $tw.wiki.getTiddlerList(\\\"$:/StoryList\\\");\\n    var index = storyList.indexOf(title);\\n    if (index !== -1) storyList.splice(index, 1);\\n    storyList.unshift(title);\\n    $tw.wiki.addTiddler(new $tw.Tiddler({title: \\\"$:/StoryList\\\", list: storyList}));\\n    setTimeout(function() {\\n        $tw.rootWidget.dispatchEvent({type: \\\"tm-navigate\\\", navigateTo: title, suppressNavigationHistory: false});\\n    }, 100);\\n}\\n\\nfunction uploadToS3(file) {\\n    $tw.notifier.display(\\\"☁️ Requesting sign: \\\" + file.name);\\n    \\n    // 1. 请求预签名 URL 和元数据\\n    fetch(`/api/sign-upload?filename=${encodeURIComponent(file.name)}&content_type=${encodeURIComponent(file.type)}`)\\n        .then(res => res.json())\\n        .then(data => {\\n            $tw.notifier.display(\\\"⬆️ Uploading...\\\");\\n            \\n            // 2. 使用签名 URL 上传文件到 S3\\n            return fetch(data.upload_url, { \\n                method: \\\"PUT\\\", \\n                body: file, \\n                headers: { \\\"Content-Type\\\": file.type } \\n            }).then(res => { \\n                if (res.ok) {\\n                    // 关键修改：返回完整的 data 对象，包含 key, bucket, region, public_url\\n                    return data; \\n                }\\n                throw new Error(\\\"S3 Upload Failed\\\"); \\n            });\\n        })\\n        .then(data => {\\n            var title = file.name;\\n            \\n            // 3. 创建 Tiddler，并写入完整的 S3 元数据\\n            // 这样删除时，Rust 端可以直接读取 _s3_key 和 _s3_bucket 进行精准删除\\n            $tw.wiki.addTiddler(new $tw.Tiddler({\\n                title: title,\\n                type: file.type,\\n                text: \\\"\\\", // 保持为空，实现 Lazy Loading\\n                \\\"_canonical_uri\\\": data.public_url,\\n                \\n                // --- 新增元数据字段 ---\\n                \\\"_file_storage\\\": \\\"s3\\\",\\n                \\\"_s3_key\\\": data.key,\\n                \\\"_s3_bucket\\\": data.bucket,\\n                \\\"_s3_region\\\": data.region,\\n                \\\"_s3_name\\\": data.name\\n            }));\\n            \\n            $tw.s3SuccessList.push(title);\\n            $tw.rootWidget.dispatchEvent({type: \\\"tm-auto-save-wiki\\\"});\\n            \\n            // 继续处理下一个文件\\n            processQueue();\\n        })\\n        .catch(err => {\\n            console.error(err);\\n            $tw.notifier.display(\\\"❌ Error: \\\" + err.message);\\n            // 即使出错也继续处理队列中的下一个\\n            processQueue();\\n        });\\n}\\n\\n})();\",\"type\":\"application/javascript\"},\"$:/plugins/custom/s3-uploader/ui-modal\":{\"footer\":\"<$button message=\\\"tm-close-tiddler\\\" class=\\\"tc-btn-invisible tc-tiddlylink\\\">Cancel</$button><$button message=\\\"tm-s3-confirm-upload\\\" class=\\\"tc-btn-big-green\\\" actions=\\\"<$action-sendmessage $message='tm-close-tiddler'/>\\\">Import to S3</$button>\",\"subtitle\":\"Confirm S3 Upload\",\"text\":\"! Ready to Upload\\n\\nThe following file will be uploaded directly to your S3/Object Storage (Lazy Loading).\\n\\n<div class=\\\"tc-message-box\\\">\\n<$transclude tiddler=\\\"$:/state/s3-upload-preview\\\" mode=\\\"block\\\"/>\\n</div>\\n\\nNote: The file content will not be stored in the TiddlyWiki database.\"}}}",
    "title": "$:/plugins/custom/s3-uploader",
    "type": "application/json",
    "version": "1.0.1"
  }
]