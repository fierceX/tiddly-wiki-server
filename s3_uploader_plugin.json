[
    {
        "title": "$:/plugins/custom/s3-uploader",
        "name": "S3 Uploader",
        "description": "S3 Lazy Uploader backed by Rust",
        "author": "fiercex",
        "version": "1.0.0",
        "plugin-type": "plugin",
        "type": "application/json",
        "text": "{\"tiddlers\":{\"$:/plugins/custom/s3-uploader/ui-modal\":{\"title\":\"$:/plugins/custom/s3-uploader/ui-modal\",\"subtitle\":\"Confirm S3 Upload\",\"footer\":\"<$button message=\\\"tm-close-tiddler\\\" class=\\\"tc-btn-invisible tc-tiddlylink\\\">Cancel</$button><$button message=\\\"tm-s3-confirm-upload\\\" class=\\\"tc-btn-big-green\\\" actions=\\\"<$action-sendmessage $message='tm-close-tiddler'/>\\\">Import to S3</$button>\",\"text\":\"! Ready to Upload\\n\\nThe following file will be uploaded directly to your S3/Object Storage (Lazy Loading).\\n\\n<div class=\\\"tc-message-box\\\">\\n<$transclude tiddler=\\\"$:/state/s3-upload-preview\\\" mode=\\\"block\\\"/>\\n</div>\\n\\nNote: The file content will not be stored in the TiddlyWiki database.\"},\"$:/plugins/custom/s3-uploader.js\":{\"title\":\"$:/plugins/custom/s3-uploader.js\",\"type\":\"application/javascript\",\"module-type\":\"startup\",\"text\":\"/*\\\\\\ntitle: $:/plugins/custom/s3-uploader.js\\ntype: application/javascript\\nmodule-type: startup\\n\\nS3 Direct Uploader (With Native-like Import Report)\\n\\\\*/\\n(function() {\\n\\n/*jslint node: true, browser: true */\\n/*global $tw: false */\\n\\\"use strict\\\";\\n\\nexports.name = \\\"s3-uploader\\\";\\nexports.platforms = [\\\"browser\\\"];\\nexports.after = [\\\"startup\\\"];\\nexports.synchronous = true;\\n\\n// Global state\\n$tw.s3PendingFiles = [];\\n$tw.s3SuccessList = [];\\n\\nexports.startup = function() {\\n    console.log(\\\"✅ S3 Uploader: Initializing...\\\");\\n    if(typeof window !== 'undefined') {\\n        window.addEventListener(\\\"dragenter\\\", onDragOver, true);\\n        window.addEventListener(\\\"dragover\\\", onDragOver, true);\\n        window.addEventListener(\\\"drop\\\", onDrop, true);\\n    }\\n    $tw.rootWidget.addEventListener(\\\"tm-s3-confirm-upload\\\", function(event) {\\n        $tw.s3SuccessList = [];\\n        processQueue();\\n    });\\n};\\n\\nfunction onDragOver(event) { event.preventDefault(); }\\n\\nfunction onDrop(event) {\\n    var dataTransfer = event.dataTransfer;\\n    if (!dataTransfer || !dataTransfer.files || dataTransfer.files.length === 0) return;\\n    var file = dataTransfer.files[0];\\n    if (file.name.endsWith(\\\".tid\\\") || file.name.endsWith(\\\".json\\\") || file.name.endsWith(\\\".html\\\")) return;\\n    event.preventDefault();\\n    event.stopPropagation();\\n    event.stopImmediatePropagation();\\n    $tw.s3PendingFiles = [file];\\n    var fileInfo = \\\"<strong>File:</strong> \\\" + file.name + \\\"<br/><strong>Size:</strong> \\\" + (file.size / 1024 / 1024).toFixed(2) + \\\" MB\\\";\\n    $tw.wiki.addTiddler(new $tw.Tiddler({title: \\\"$:/state/s3-upload-preview\\\", text: fileInfo}));\\n    $tw.modal.display(\\\"$:/plugins/custom/s3-uploader/ui-modal\\\");\\n}\\n\\nfunction processQueue() {\\n    if ($tw.s3PendingFiles.length === 0) { finishBatch(); return; }\\n    var file = $tw.s3PendingFiles.shift();\\n    uploadToS3(file);\\n}\\n\\nfunction finishBatch() {\\n    if ($tw.s3SuccessList.length === 0) return;\\n    var listText = \\\"The following files were successfully uploaded to S3 (Lazy Loaded):\\\\n\\\\n\\\";\\n    $tw.s3SuccessList.forEach(function(title) { listText += \\\"* [[\\\" + title + \\\"]]\\\\n\\\"; });\\n    var reportTitle = \\\"$:/plugins/custom/s3-uploader/ui-report\\\";\\n    $tw.wiki.addTiddler(new $tw.Tiddler({title: reportTitle, text: listText, tags: [\\\"$:/tags/ImportResult\\\"], \\\"caption\\\": \\\"S3 Upload Report\\\", \\\"icon\\\": \\\"$:/core/images/cloud\\\"}));\\n    $tw.notifier.display(\\\"✅ Batch upload complete\\\");\\n    openTiddler(reportTitle);\\n}\\n\\nfunction openTiddler(title) {\\n    var storyList = $tw.wiki.getTiddlerList(\\\"$:/StoryList\\\");\\n    var index = storyList.indexOf(title);\\n    if (index !== -1) storyList.splice(index, 1);\\n    storyList.unshift(title);\\n    $tw.wiki.addTiddler(new $tw.Tiddler({title: \\\"$:/StoryList\\\", list: storyList}));\\n    setTimeout(function() {\\n        $tw.rootWidget.dispatchEvent({type: \\\"tm-navigate\\\", navigateTo: title, suppressNavigationHistory: false});\\n    }, 100);\\n}\\n\\nfunction uploadToS3(file) {\\n    $tw.notifier.display(\\\"☁️ Requesting sign: \\\" + file.name);\\n    fetch(`/api/sign-upload?filename=${encodeURIComponent(file.name)}&content_type=${encodeURIComponent(file.type)}`)\\n        .then(res => res.json())\\n        .then(data => {\\n            $tw.notifier.display(\\\"⬆️ Uploading...\\\");\\n            return fetch(data.upload_url, { method: \\\"PUT\\\", body: file, headers: { \\\"Content-Type\\\": file.type } }).then(res => { if (res.ok) return data.public_url; throw new Error(\\\"S3 Upload Failed\\\"); });\\n        })\\n        .then(publicUrl => {\\n            var title = file.name;\\n            $tw.wiki.addTiddler(new $tw.Tiddler({title: title, type: file.type, text: \\\"\\\", \\\"_canonical_uri\\\": publicUrl}));\\n            $tw.s3SuccessList.push(title);\\n            $tw.rootWidget.dispatchEvent({type: \\\"tm-auto-save-wiki\\\"});\\n            processQueue();\\n        })\\n        .catch(err => {\\n            console.error(err);\\n            $tw.notifier.display(\\\"❌ Error: \\\" + err.message);\\n            processQueue();\\n        });\\n}\\n\\n})();\"}}}"
    }
]